<div class="row">
    <div id="filter-report" class="col-md-3 col-md-push-9 col-sm-12 hidden-sm hidden-xs">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title"><i class="fa fa-filter"></i> {{ text_filter }}</h3>
            </div>
            <div class="panel-body">
                <div class="form-group">
                    <label class="control-label" for="input-manager">Odaberi komercijalista</label>
                    <select name="filter_manager" id="input-manager" class="form-control" placeholder="Odaberi komercijalista">
                        <option></option>
                        {% for manager in managers %}
                            {% if manager.id == filter_manager %}
                                <option value="{{ manager.id }}" selected="selected">{{ manager.value }}</option>
                            {% else %}
                                <option value="{{ manager.id }}">{{ manager.value }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label class="control-label" for="input-date-start">{{ entry_date_start }}</label>
                    <div class="input-group date">
                        <input type="text" name="filter_date_start" value="{{ filter_date_start }}" placeholder="{{ entry_date_start }}" data-date-format="YYYY-MM-DD" id="input-date-start" class="form-control" />
                        <span class="input-group-btn"><button type="button" class="btn btn-default"><i class="fa fa-calendar"></i></button></span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="control-label" for="input-date-end">{{ entry_date_end }}</label>
                    <div class="input-group date">
                        <input type="text" name="filter_date_end" value="{{ filter_date_end }}" placeholder="{{ entry_date_end }}" data-date-format="YYYY-MM-DD" id="input-date-end" class="form-control" />
                        <span class="input-group-btn"><button type="button" class="btn btn-default"><i class="fa fa-calendar"></i></button></span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="control-label" for="input-status">{{ entry_status }}</label>
                    <select name="filter_order_status_id" id="input-status" class="form-control">
                        <option value="0">{{ text_all_status }}</option>
                        {% for order_status in order_statuses %}
                            {% if order_status.order_status_id == filter_order_status_id %}
                                <option value="{{ order_status.order_status_id }}" selected="selected">{{ order_status.name }}</option>
                            {% else %}
                                <option value="{{ order_status.order_status_id }}">{{ order_status.name }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group text-right">
                    <button type="button" id="button-filter" class="btn btn-default"><i class="fa fa-filter"></i> {{ button_filter }}</button>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-9 col-md-pull-3 col-sm-12">
        {# Timeline panel #}
        <div class="panel panel-default" id="panel-sessions" {% if not filter_manager %}style="display:none"{% endif %}>
            <div class="panel-heading">
                <h3 class="panel-title"><i class="fa fa-clock-o"></i> Sesije (trajanje prijava) — Timeline</h3>
            </div>
            <div class="panel-body">
                <canvas id="sessionChart" height="120"></canvas>
                <div class="help-block js-mini-legend" style="margin-top:6px; display:none;"></div>
                <div id="sessionTable" class="table-responsive" style="margin-top:15px;"></div>
            </div>
        </div>

        {# Selected session activity #}
        <div class="panel panel-default" id="panel-session-detail" style="display:none;">
            <div class="panel-heading">
                <h3 class="panel-title"><i class="fa fa-bullseye"></i> Aktivnost u odabranoj sesiji</h3>
            </div>
            <div class="panel-body">
                <div class="row">
                    <div class="col-sm-6">
                        <canvas id="sessionEventChart" height="220"></canvas>
                    </div>
                    <div class="col-sm-6">
                        <canvas id="sessionTimelineChart" height="220"></canvas>
                    </div>
                </div>
                <div class="row" style="margin-top:12px;">
                    <div class="col-sm-12" id="sessionTopLists"></div>
                </div>
            </div>
        </div>

        {# Existing totals table (now includes Sessions column) #}
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title"><i class="fa fa-bar-chart"></i> {{ heading_title }}</h3>
            </div>
            <div class="panel-body">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                        <tr>
                            <td class="text-left">{{ column_order_manager }}</td>
                            <td class="text-left">{{ column_date_start }}</td>
                            <td class="text-left">{{ column_date_end }}</td>
                            <td class="text-right">Sesije</td>
                            <td class="text-right">{{ column_orders }}</td>
                            <td class="text-right">{{ column_products }}</td>
                            <td class="text-right">{{ column_tax }}</td>
                            <td class="text-right">{{ column_total }}</td>
                        </tr>
                        </thead>
                        <tbody>
                        {% if orders %}
                            {% for order in orders %}
                                <tr>
                                    <td class="text-left">{{ order.manager }}</td>
                                    <td class="text-left">{{ order.date_start }}</td>
                                    <td class="text-left">{{ order.date_end }}</td>
                                    <td class="text-right"><span class="label label-info">{{ order.sessions }}</span></td>
                                    <td class="text-right">{{ order.orders }}</td>
                                    <td class="text-right">{{ order.products }}</td>
                                    <td class="text-right">{{ order.tax }}</td>
                                    <td class="text-right">{{ order.total }}</td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td class="text-center" colspan="8">{{ text_no_results }}</td>
                            </tr>
                        {% endif %}
                        </tbody>
                    </table>
                </div>
                <div class="row">
                    <div class="col-sm-6 text-left">{{ pagination }}</div>
                    <div class="col-sm-6 text-right">{{ results }}</div>
                </div>
            </div>
        </div>

        {% if manager_orders %}
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title"><i class="fa fa-bar-chart"></i> Narudžbe po komercijalistima</h3>
                </div>
                <div class="panel-body">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                            <tr>
                                <td class="text-left">Kupac</td>
                                <td class="text-left">Datum / Komercijalist</td>
                                <td class="text-right">{{ column_products }}</td>
                                <td class="text-right">{{ column_tax }}</td>
                                <td class="text-right">{{ column_total }}</td>
                            </tr>
                            </thead>
                            <tbody>
                            {% for order in manager_orders %}
                                <tr>
                                    <td class="text-left">{{ order.customer }}</td>
                                    <td class="text-left">{{ order.manager }}</td>
                                    <td class="text-right">{{ order.products }}</td>
                                    <td class="text-right">{{ order.tax }}</td>
                                    <td class="text-right">{{ order.total }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script type="text/javascript"><!--
    $('#button-filter').on('click', function() {
        var url = '';

        var filter_manager = $('select[name="filter_manager"]').val();
        if (filter_manager) url += '&filter_manager=' + encodeURIComponent(filter_manager);

        var filter_date_start = $('input[name="filter_date_start"]').val();
        if (filter_date_start) url += '&filter_date_start=' + encodeURIComponent(filter_date_start);

        var filter_date_end = $('input[name="filter_date_end"]').val();
        if (filter_date_end) url += '&filter_date_end=' + encodeURIComponent(filter_date_end);

        var filter_group = $('select[name="filter_group"]').val();
        if (filter_group) url += '&filter_group=' + encodeURIComponent(filter_group);

        var filter_order_status_id = $('select[name="filter_order_status_id"]').val();
        if (filter_order_status_id != 0) url += '&filter_order_status_id=' + encodeURIComponent(filter_order_status_id);

        location = 'index.php?route=report/report&code=order_manager_sales&user_token={{ user_token }}' + url;
    });

    $('.date').datetimepicker({ language: '{{ datepicker }}', pickTime: false });
    --></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script type="text/javascript"><!--
    (function() {
        if (!'{{ filter_manager }}') return;

        var utok = '{{ user_token }}';
        var url = 'index.php?route=extension/report/order_manager_sales/sessions&user_token={{ user_token }}'
            + '&filter_manager={{ filter_manager|e }}'
            + '&filter_date_start={{ filter_date_start|e }}'
            + '&filter_date_end={{ filter_date_end|e }}';

        $.getJSON(url, function(payload) {
            var sessions = payload.sessions || [];

            // ---- Timeline chart (colored by order presence) ----
            var labels  = sessions.map(function(s) {
                var start = new Date(s.start.replace(' ', 'T'));
                var hh = ('0' + start.getHours()).slice(-2);
                var mm = ('0' + start.getMinutes()).slice(-2);
                return start.toLocaleDateString() + ' ' + hh + ':' + mm + (s.order_id ? ' (#' + s.order_id + ')' : '');
            });
            var minutes = sessions.map(function(s) { return s.duration_minutes; });

            var barColors   = sessions.map(function(s){ return s.order_id ? 'rgba(46, 204, 113, 0.85)' : 'rgba(52, 152, 219, 0.70)'; });
            var borderColors= sessions.map(function(s){ return s.order_id ? 'rgb(39, 174, 96)' : 'rgb(41, 128, 185)'; });

            var ctx = document.getElementById('sessionChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'Trajanje sesije (minute)', data: minutes, backgroundColor: barColors, borderColor: borderColors, borderWidth: 1 }] },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        tooltip: { callbacks: {
                                afterLabel: function(context){
                                    var i = context.dataIndex;
                                    var s = sessions[i];
                                    return s.order_id ? '  Narudžba: #' + s.order_id : '';
                                }
                            }}
                    },
                    scales: { x: { ticks: { autoSkip:false, maxRotation:45 } }, y: { beginAtZero:true } }
                }
            });

            var legendHtml = ''
                + '<span style="display:inline-block;width:12px;height:12px;background:#27ae60;border:1px solid #1e8449;margin-right:6px;vertical-align:middle;"></span>'
                + 'Sesija s narudžbom '
                + '<span style="display:inline-block;width:12px;height:12px;background:#3498db;border:1px solid #2c81ba;margin:0 6px 0 12px;vertical-align:middle;"></span>'
                + 'Bez narudžbe';
            $('.js-mini-legend').html(legendHtml).show();

            // ---- Session table (with Aktivnost button) ----
            var html = '';
            if (sessions.length) {
                html += '<table class="table table-bordered"><thead><tr>'
                    + '<td class="text-left">Početak</td>'
                    + '<td class="text-left">Kraj</td>'
                    + '<td class="text-right">Minute</td>'
                    + '<td class="text-right">Narudžba</td>'
                    + '<td class="text-right">Akcija</td>'
                    + '</tr></thead><tbody>';

                sessions.forEach(function(s) {
                    html += '<tr class="js-session-row" data-sid="'+s.id+'">'
                        + '<td class="text-left">' + s.start + '</td>'
                        + '<td class="text-left">' + (s.end || '-') + '</td>'
                        + '<td class="text-right">' + s.duration_minutes + '</td>'
                        + '<td class="text-right">' + (s.order_id ? ('#' + s.order_id) : '-') + '</td>'
                        + '<td class="text-right">'
                        + '<button type="button" class="btn btn-xs btn-info js-session-activity" data-sid="'+s.id+'">'
                        +   '<i class="fa fa-bullseye"></i> Aktivnost'
                        + '</button>'
                        + '</td>'
                        + '</tr>';
                });

                html += '</tbody></table>';
            } else {
                html = '<div class="text-center text-muted">{{ text_no_results }}</div>';
            }
            $('#sessionTable').html(html);

            // Row click OR “Aktivnost” button loads detail
            $('#sessionTable').on('click', '.js-session-row', function(e){
                if ($(e.target).closest('.js-session-activity').length) return;
                var sid = $(this).data('sid');
                loadSessionDetail(sid);
                $('.js-session-row').removeClass('info');
                $(this).addClass('info');
            });
            $('#sessionTable').on('click', '.js-session-activity', function(e){
                e.preventDefault(); e.stopPropagation();
                var sid = $(this).data('sid');
                loadSessionDetail(sid);
                $('.js-session-row').removeClass('info');
                $(this).closest('tr').addClass('info');
            });
        });

        // ----- Selected session detail (donut + timeline + top lists) -----
        var detailChart, timelineChart;

        function loadSessionDetail(sessionId) {
            if (!sessionId) return;
            $('#panel-session-detail').show();

            // 1) Summary + top lists
            $.getJSON('index.php?route=extension/report/order_manager_sales/session_event_stats&user_token={{ user_token }}&session_id=' + sessionId, function(stats){
                var summary = stats.summary || [];
                var labels = summary.map(function(r){
                    switch(r.entity_type){
                        case 'product': return 'Proizvodi';
                        case 'category': return 'Kategorije';
                        case 'manufacturer': return 'Proizvođači';
                        case 'information': return 'Informacije';
                        case 'search': return 'Pretraga';
                        case 'cart': return 'Košarica';
                        case 'checkout': return 'Checkout';
                        case 'page': default: return 'Stranice';
                    }
                });
                var values = summary.map(function(r){ return parseInt(r.clicks, 10) || 0; });

                var ctx = document.getElementById('sessionEventChart').getContext('2d');
                if (detailChart && typeof detailChart.destroy === 'function') detailChart.destroy();
                detailChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels: labels, datasets: [{ data: values }] },
                    options: { responsive:true, plugins:{ legend:{ position:'bottom' } } }
                });

                // Top lists with edit links
                var utok = '{{ user_token }}';
                var lists = '';
                function list(title, rows, kind){
                    if (!rows || !rows.length) return '<p class="text-muted" style="margin:8px 0;">Nema klikova za ' + title.toLowerCase() + '.</p>';
                    var out = '<h4 style="margin-top:10px;">' + title + '</h4><ul class="list-unstyled">';
                    rows.forEach(function(r){
                        var label = (r.name || r.title || ('ID ' + (r.product_id||r.category_id||r.manufacturer_id||r.information_id)));
                        var id = r.product_id || r.category_id || r.manufacturer_id || r.information_id;
                        var href = '#';
                        if (kind === 'product')      href = 'index.php?route=catalog/product/edit&user_token=' + utok + '&product_id=' + id;
                        if (kind === 'category')     href = 'index.php?route=catalog/category/edit&user_token=' + utok + '&category_id=' + id;
                        if (kind === 'manufacturer') href = 'index.php?route=catalog/manufacturer/edit&user_token=' + utok + '&manufacturer_id=' + id;
                        if (kind === 'information')  href = 'index.php?route=catalog/information/edit&user_token=' + utok + '&information_id=' + id;
                        out += '<li><a href="'+href+'">'+label+'</a> <span class="badge pull-right">'+(r.clicks||0)+'</span></li>';
                    });
                    out += '</ul>';
                    return out;
                }
                lists += list('Proizvodi (Top 10)',      stats.products,      'product');
                lists += list('Kategorije (Top 10)',     stats.categories,    'category');
                lists += list('Proizvođači (Top 10)',    stats.manufacturers, 'manufacturer');
                lists += list('Informacije (Top 10)',    stats.information,   'information');
                $('#sessionTopLists').html(lists);
            });

            // 2) Timeline by minute & type
            $.getJSON('index.php?route=extension/report/order_manager_sales/session_event_timeline&user_token={{ user_token }}&session_id=' + sessionId, function(payload){
                var labels = payload.labels || [];
                var s = payload.series || {};

                var datasets = [];
                function add(nameKey, nice, color) {
                    if (!s[nameKey]) return;
                    datasets.push({
                        label: nice, data: s[nameKey],
                        fill: false, borderWidth: 2, tension: 0.2,
                        borderColor: color, backgroundColor: color, pointRadius: 2
                    });
                }
                add('product','Proizvodi','#8e44ad');
                add('category','Kategorije','#d35400');
                add('manufacturer','Proizvođači','#16a085');
                add('information','Informacije','#7f8c8d');
                add('search','Pretraga','#f1c40f');
                add('cart','Košarica','#2980b9');
                add('checkout','Checkout','#c0392b');
                add('page','Stranice','#2ecc71');

                var ctx2 = document.getElementById('sessionTimelineChart').getContext('2d');
                if (timelineChart && typeof timelineChart.destroy === 'function') timelineChart.destroy();
                timelineChart = new Chart(ctx2, {
                    type: 'line',
                    data: { labels: labels, datasets: datasets },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'bottom' } },
                        scales: {
                            x: { ticks: { maxRotation: 45, minRotation: 0 } },
                            y: { beginAtZero: true, precision: 0 }
                        }
                    }
                });
            });
        }
    })();
    --></script>
